            <link rel="stylesheet" href="/static/modal.css">

            <!--The next two divs contain the modals for this page-->

            <div id="move_exercise_modal" class="modal">
                <form method="post" action="/move_exercise/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}">
                <div class="modal-content">
                    <!--<span class="close">&times;</span>-->
                    <p>Move an exercise to a different assignment:</p>
                    <div class="select is-light">
                        <select name="new_assignment_id" id="new_assignment_id">
                        {% for assignment in assignment_options %}
                            <option value="{{ assignment['id'] }}">{{ assignment["title"] }}</option>
                        {% end %}
                        </select>
                    </div>
                    <p class="buttons">
                        <a id="move_cancel_button" class="modal-button button is-light">Cancel</a>
                        <input type="submit" id="move_button" class="modal-button button is-dark" value="Move"/>
                    </p>
                </div>
                </form>
            </div>

            <div id="delete_submissions_modal" class="modal">
                <div class="modal-content">
                    <!--<span class="close">&times;</span>-->
                    <p>Are you sure you want to delete all submissions for this exercise?</p>
                    <p><font color="red">This will also delete all scores for this exercise.</font></p>
                    <p class="buttons">
                        <a id="delete_submissions_cancel_button" class="modal-button button is-light">Cancel</a>
                        <input type="submit" id="delete_submissions_button" class="modal-button button is-dark" value="Delete"/>
                    </p>
                </div>
            </div>

            <!--Navigation links at the bottom of the page-->

            <p>
            {% if is_administrator or is_instructor or is_assistant %}
                <a href="/exercise_scores/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}">View scores</a>
            {% end %}

            {% if is_administrator or is_instructor %}
                | <a onclick="showMoveExerciseModal()">Move exercise</a><br />
                <a onclick="showDeleteSubmissionsModal()">Delete exercise submissions</a>
            {% end %}

            </p>

            <a href="/assignment/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}">Back to exercise list</a>

            {% if student_id == user_id %}
                <br /><br />
            {% end %}

            <script>
                function showMoveExerciseModal() {
                    var modal = document.getElementById("move_exercise_modal");
                    //var span = document.getElementsByClassName("close")[4];
                    modal.style.display = "block";

                    var cancelButton = document.getElementById("move_cancel_button");

                    cancelButton.onclick = function() {
                        modal.style.display = "none";
                    }

                    /*span.onclick = function() {
                        modal.style.display = "none";
                    }*/

                    window.onclick = function(event) {
                        if (event.target == modal) {
                            modal.style.display = "none";
                        }
                    }
                }

                function showDeleteSubmissionsModal() {
                    var modal = document.getElementById("delete_submissions_modal");
                    // var span = document.getElementsByClassName("close")[5];
                    modal.style.display = "block";

                    var deleteButton = document.getElementById("delete_submissions_button");
                    var cancelButton = document.getElementById("delete_submissions_cancel_button");

                    deleteButton.onclick = function() {
                        $.post("/delete_exercise_submissions/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}");
                        modal.style.display = "none";
                        location.reload();
                    }

                    cancelButton.onclick = function() {
                        modal.style.display = "none";
                    }

                    /*span.onclick = function() {
                        modal.style.display = "none";
                    }*/

                    window.onclick = function(event) {
                        if (event.target == modal) {
                            modal.style.display = "none";
                        }
                    }
                }

                submitButton = document.getElementById("submit_button");

                {% if exercise_details["enable_pair_programming"] %}
                if (submitButton != null)
                 submitButton.onclick = function() {
                    submitModal()
                }
                {% else %}
                (submitButton != null)
                  submitButton.onclick = function() {
                      submit()
                }
                {% end %}

                function submit() {
                    user_code = editor.getValue();

                    if (user_code.trim() == "")
                        return false;

                    // get partner_id
                    let partner_key = document.getElementById("pair_programming").value == "Yes" ? document.getElementById("partner_key").value : null;

                    result_div = document.getElementById("result");
                    result_div.innerHTML = "<div class='notification is-warning is-light smaller-font'>Please wait while your solution is being executed...</div>";
                    result_div.scrollIntoView();

                    {% if exercise_details["back_end"] != "any_response" %}
                        document.getElementById("code_output").innerHTML = "";

                        {% if exercise_details["show_expected"] %}
                            document.getElementById("diff_output").innerHTML = "";
                        {% end %}
                    {% end %}

                    post_data = { "partner_key": partner_key, "user_code": user_code, "date": new Date().toLocaleString("en-US", {timeZone: "UTC"})};

                    $.post("/submit/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}",
                        post_data,
                       function(data, status) {
                           json_data = JSON.parse(data);
                           check_code(json_data);

                           if (json_data.submission_id != "") {
                               show_past_submissions();
                               last_submission_id = json_data.submission_id;

                               {% if exercise_details["max_submissions"] > 0 %}
                                   document.getElementById("num_submissions").innerHTML = last_submission_id;

                                   if (last_submission_id >= {{ exercise_details["max_submissions"] }})
                                       document.getElementById("submit_button").disabled = true;
                               {% end %}
                           }
                       });
                   editor.focus();
                   return false;
                }
                function submitModal() {
                    var modal = document.getElementById("submit_exercise_modal");
                    var span = document.getElementsByClassName("close")[4];

                    modal.style.display = "block";

                 {% if exercise_details["enable_pair_programming"] %}
                 if (submitButton != null)
                  submitButton.onclick = function() {
                     submitModal()
                 }
                 {% else %}
                 (submitButton != null)
                   submitButton.onclick = function() {
                       submit()
                 }
                 {% end %}

                 function submit() {
                     user_code = editor.getValue();

                     if (user_code.trim() == "")
                         return false;

                     // get partner_id
                     let partner_key = document.getElementById("pair_programming").value == "Yes" ? document.getElementById("partner_key").value : null;

                     result_div = document.getElementById("result");
                     result_div.innerHTML = "<div class='notification is-warning is-light smaller-font'>Please wait while your solution is being executed...</div>";
                     result_div.scrollIntoView();

                     {% if exercise_details["back_end"] != "any_response" %}
                         document.getElementById("code_output").innerHTML = "";

                         {% if exercise_details["show_expected"] %}
                             document.getElementById("diff_output").innerHTML = "";
                         {% end %}
                     {% end %}

                     post_data = { "partner_key": partner_key, "user_code": user_code, "date": new Date().toLocaleString("en-US", {timeZone: "UTC"})};

                     $.post("/submit/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}",
                         post_data,
                        function(data, status) {
                            json_data = JSON.parse(data);
                            check_code(json_data);

                            if (json_data.submission_id != "") {
                                show_past_submissions();
                                last_submission_id = json_data.submission_id;

                                {% if exercise_details["max_submissions"] > 0 %}
                                    document.getElementById("num_submissions").innerHTML = last_submission_id;

                                    if (last_submission_id >= {{ exercise_details["max_submissions"] }})
                                        document.getElementById("submit_button").disabled = true;
                                {% end %}
                            }
                        });
                    editor.focus();
                    return false;
                 }
                 function submitModal() {
                     var modal = document.getElementById("submit_exercise_modal");
                     var span = document.getElementsByClassName("close")[4];

                     modal.style.display = "block";

                     var cancelButton = document.getElementById("submit_cancel_button");
                     var modalSubmitButton = document.getElementById("modal_submit_button");

                     modalSubmitButton.onclick = function() {
                       let partner_key = {"partner_key": document.getElementById("partner_key").value};
                       if (document.getElementById("pair_programming").value == "Yes") {
                         $.post("/check_partners/{{ course_basics['id'] }}", partner_key,
                            function(data, status) {
                                if(!(JSON.parse(data))) {
                                  document.getElementById("invalid_partner").innerHTML = "<div style='margin:15px 0px' class='space_div notification is-warning is-light smaller-font'>Invalid partner chosen, please try again.</div>";
                                } else {
                                  submit();
                                  modal.style.display = "none";
                                  location.reload();
                                }
                         });
                       } else {
                         submit();
                         modal.style.display = "none";
                         location.reload();
                       }
                     }

                     cancelButton.onclick = function() {
                         modal.style.display = "none";
                     }

                     span.onclick = function() {
                         modal.style.display = "none";
                     }

                     window.onclick = function(event) {
                         if (event.target == modal) {
                             modal.style.display = "none";
                         }
                     }
                 }

                 function get_submission(submission_id, scroll) {
                    var submission_buttons = document.getElementsByClassName('button is-primary is-medium');
                    if (document.getElementById("saved_div") != null)
                        document.getElementById("saved_div").innerHTML = "";

                    var i;
                    for (i = 0; i < submission_buttons.length; i++) {
                        if (submission_buttons[i].id == submission_id)
                            submission_buttons[i].style.border = "solid #34495e";
                        else
                            submission_buttons[i].style.border = "none";
                    }

                    cancelButton.onclick = function() {
                        modal.style.display = "none";
                    }

                    span.onclick = function() {
                        modal.style.display = "none";
                    }

                    window.onclick = function(event) {
                        if (event.target == modal) {
                            modal.style.display = "none";
                        }
                    }
                }

                function get_submission(submission_id, scroll) {
                   var submission_buttons = document.getElementsByClassName('button is-primary is-medium');
                   if (document.getElementById("saved_div") != null)
                       document.getElementById("saved_div").innerHTML = "";

                   var i;
                   for (i = 0; i < submission_buttons.length; i++) {
                       if (submission_buttons[i].id == submission_id)
                           submission_buttons[i].style.border = "solid #34495e";
                       else
                           submission_buttons[i].style.border = "none";
                   }

                   {% if exercise_details["back_end"] != "any_response" %}
                       document.getElementById("code_output").innerHTML = "";

                       {% if exercise_details["show_expected"] %}
                           document.getElementById("diff_output").innerHTML = "";
                       {% end %}
                   {% end %}

                   {% if exercise_details["show_expected"] and exercise_details["back_end"] != "any_response" %}
                       document.getElementById("diff_output").innerHTML = "";
                   {% end %}

                   $.get("/get_submission/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}/{{ student_id }}/" + submission_id,
                       function (data, status) {
                           var json_data = JSON.parse(data);
                           editor.setValue(json_data.code, 1);
                           check_code(json_data);
                       });

                    if (scroll && document.getElementById("your_code_header") != null)
                       document.getElementById("your_code_header").scrollIntoView();

                   editor.focus();

                   return false;
               }

               function show_past_submissions() {
                   submissions_div = document.getElementById("submissions");
                   $.get("/get_submissions/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}/{{ student_id }}",
                       function (data, status) {
                           var json_data = JSON.parse(data);
                           var submission_html = "";
                           var revert_html = "";
                           var current_code = editor.getValue()

                           $.get("/get_presubmission/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}/{{ student_id }}",
                           function(data, status) {
                             var presubmission_data = JSON.parse(data);

                             //show student's presubmission, if applicable
                             if (presubmission_data != null){
                               editor.setValue(presubmission_data.code);
                               if (document.getElementById("saved_div") != null)
                                 document.getElementById("saved_div").innerHTML = "Code loaded from last session";
                             }

                             if (json_data.length > 0) {
                                 submission_html += "<h6>Past submissions:</h6>\n";
                                 submission_html += "<div class='buttons'>\n";
                                 var i;

                                 for (i = 0; i < json_data.length; i++) {
                                     submission_id = json_data[i][0];
                                     the_date = json_data[i][1];
                                     passed = json_data[i][2];
                                     partner_name = json_data[i][3]

                                     //show student's most recent submission
                                     if (i == 0 && presubmission_data == null)
                                         get_submission(submission_id, false);

                                     if (passed)
                                         button_bg_color = "passing-btn-color";
                                     else
                                         button_bg_color = "failing-btn-color";

                                     var submission_date = new Date(the_date).toLocaleString();

                                     if (partner_name) {
                                       submission_html += `<button class='button ${button_bg_color}' id='${submission_id}' style='display: block; width: 315px;' onclick='get_submission(${submission_id}, true)'><b>${submission_id}.</b> ${submission_date} <label class="has-tooltip-multiline has-tooltip-right" data-tooltip="Pair programmed with ${partner_name}."><i class="fab fa-product-hunt"></i></label></button>`;
                                     }
                                     else {
                                       submission_html += `<button class='button ${button_bg_color}' id='${submission_id}' style='display: block; width: 315px;' onclick='get_submission(${submission_id}, true)'><b>${submission_id}.</b> ${submission_date}</button>`;
                                     }
                                                                     }
                                 submission_html += "</div><br />\n";
                             }
                             submissions_div.innerHTML = submission_html;
                           });
                       });
               }
           </script>

           <script>
           ace.require("ace/ext/language_tools");
           var editor = ace.edit("user_code", {
               theme: "ace/theme/{{ user_info['ace_theme'] }}",
               autoScrollEditorIntoView: false,
               minLines: 20,
               fontSize: "12pt"
           });
           let codeChanged = false

           editor.session.on('change', function(delta) {
             codeChanged = true
           });

           setInterval(function() {
             // autosave if code has changed
             if (codeChanged) {
               save_presubmission();
             }
           }, 60 * 1000);

           async function save_presubmission() {
             user_code = editor.getValue();
             if (user_code.trim() == "")
               return false;
             saved_div = document.getElementById("saved_div");
             saved_div.innerHTML = "Please wait while your code is being saved...";
             await $.post("/save_presubmission/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}", {"user_code": user_code});

             codeChanged = false;
             last_saved_at = new Intl.DateTimeFormat('default', {
               hour: 'numeric',
               minute: 'numeric',
             }).format(Date.now())
             saved_div.innerHTML = `Last saved at ${last_saved_at}`
           }
           {% if user_info["enable_vim"] %}
              editor.setKeyboardHandler("ace/keyboard/vim");
           {% end %}
           {% if user_info["use_auto_complete"] and exercise_details["back_end"] != "any_response" and exercise_details["back_end"] != "free_response" %}
               editor.setOptions({
                   enableBasicAutocompletion: false,
                   enableSnippets: true,
                   enableLiveAutocompletion: true
               });
           {% end %}

           editor.focus();
           editor.getSession().setMode("{{ code_completion_path }}");
           show_past_submissions();
           last_submission_id = {{ num_submissions }};

           if ({{ exercise_details["max_submissions"] }} > 0 && last_submission_id >= {{ exercise_details["max_submissions"] }})
               document.getElementById("submit_button").disabled = true;
           </script>

       {% else %}
           <p>This exercise does not exist.</p>
       {% end %}
   {% else %}
       <p>This assignment does not exist.</p>
   {% end %}
{% else %}
   <p>This course does not exist.</p>
{% end %}
