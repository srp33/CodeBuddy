<!-- <copyright_statement>-->
<!--   CodeBuddy: A programming assignment management system for short-form exercises-->
<!--   Copyright (C) 2023 Stephen Piccolo-->
<!--   This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more details. You should have received a copy of the GNU Affero General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.-->
<!-- </copyright_statement>-->

{% if course_basics["exists"] %}
    {% if assignment_basics["exists"] %}
        {% if exercise_basics["exists"] %}
            <link rel="stylesheet" href="/static/css/modal.css">

            <div class="columns">
                {% if use_virtual_assistant %}
                    <div class="column is-two-thirds mt-0" id="left_column">
                {% else %}
                    <div class="column is-full mt-0">
                {% end %}

                    {% if assignment_details["due_date"] and assignment_details["due_date_passed"] and assignment_details["view_answer_late"] %}
                        <div class='notification is-warning is-light'>The due date for this assignment has passed, but your instructor has enabled viewing the answer.</div>
                    {% end %}

                    {% if assignment_details["due_date"] and assignment_details["due_date_passed"] and assignment_details["allow_late"] %}
                        <div class='notification is-warning is-light'>The due date for this assignment has passed, but you can make late submissions for {{ round(assignment_details["late_percent"] * 100) }}% of the points.</div>
                    {% end %}

                    <div class="has-background-white mt-0 p-4">
                        <div id="instructions">
                            <h4>{{ exercise_basics["title"] }}</h4>

                            {{ exercise_details["instructions"] }}
                            
                            {% if "previous_submission_code" in exercise_details %}
                                <p><a class="button is-primary is-outlined" onclick="copy_code_from_previous_exercise()">Copy code from previous exercise</a></p>
                            {% end %}
                        </div>

                        {% if exercise_basics["enable_pair_programming"] %}
                            <hr>
                            <p><i style='margin: 0 .5em;' class="fab fa-product-hunt"></i><em>Pair programming is enabled for this exercise.</em></p>
                        {% end %}
                    </div>

                    {% if len(exercise_details["data_files"]) > 0 %}
                        <div id="data_file_div" class="top-space">
                        <h6>Data files:</h6>
                        {% for data_file_index in range(len(exercise_details["data_files"])) %}
                            <p>
                                <a class="is-family-monospace is-size-5" href="/download_file/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}/{{ sorted(list(exercise_details['data_files'].keys()))[data_file_index] }}">{{ sorted(list(exercise_details["data_files"].keys()))[data_file_index] }}</a>
                                <a class="button is-white" id="data_button_{{ data_file_index }}" onclick="showHideData('data_panel_{{ data_file_index }}', 'data_button_{{ data_file_index }}')">Show</a>
                            </p>
                            <pre id="data_panel_{{ data_file_index }}" hidden>
                                {{ exercise_details["data_files"][sorted(list(exercise_details["data_files"].keys()))[data_file_index]] }}
                            </pre>
                        {% end %}
                        </div>
                    {% end %}

                    {% if exercise_details["hint"] != "" %}
                        <div class="top-space">
                            <button id="hint_button" class="button is-warning" onclick="showHideHint()">Show hint</button>
                        </div>

                        <div id="hint_text" class="is-hidden hint-text"><p style="margin-top: 10px;">{{ exercise_details["hint"] }}</p></div>
                    {% end %}

                    <p class="top-space" id="user_code_area">
                        <textarea class="textarea is-fullwidth monospace" rows="15" id="user_code">{% if exercise_details["starter_code"] and len(submissions) == 0 %}{{ exercise_details["starter_code"] }}{% end %}</textarea>
                    </p>
                </div>

                {% if use_virtual_assistant %}
                    <!--<div class="column is-one-quarter has-background-white is-outlined mt-3 mb-3">-->
                    <div class="column is-one-third has-background-white is-outlined mt-3 mb-3" style="overflow: scroll;" id="right_column">
                        <div id="virtual_assistant_message">
                            <p class="is-size-6">
                                <strong>Hello, I am your Virtual Assistant!</strong> Do your best to solve this exercise on your own. But if you get stuck, you can enter a question below. This feature is experimental, so its advice might or might not be helpful.
                            </p>

                            {% if assignment_details["use_virtual_assistant"] > 1 %}
                                <p class="is-size-6"><em><font color="red">The instructor is testing this feature in a research study. Therefore, please use do not share it with other students who may not have access to it on this exercise.</font></em></p>
                            {% end %}
                        </div>

                        <p><textarea id="virtual_assistant_input" class="textarea is-medium is-info is-size-6 mt-4" style="font-family: sans-serif;" placeholder="Enter your question here."></textarea></p>

                        <button id="virtual_assistant_button" class="button is-info m-0 is-size=6" onclick="askVirtualAssistant()">Ask</button>

                        <button class="button is-info is-outlined m-0 is-size=6" onclick="closeVirtualAssistant()">Close</button>

                        <div id="virtual_assistant_allowed_panel" class="smaller-font is-pulled-right mt-2 mr-1 is-hidden">
                            <em>
                                <span id="virtual_assistant_questions_allowed_prefix"></span>
                                
                                <span id="virtual_assistant_questions_allowed">
                                    {{ virtual_assistant_max_per_exercise }}
                                </span>

                                <span id="virtual_assistant_questions_allowed_suffix"></span>
                            </em>
                        </div>

                        <div id="virtual_assistant_output" class="box mt-2 mb-2 p-1 is-hidden is-size-6"></div>
                    </div>
                {% end %}
            </div>

            <div class="content is-pulled-right is-flex-tablet is-flex-mobile">
                <div id="saved_div" class="smaller-font ml-0 mt-0 mr-2 mt-0"></div>

                <div class="smaller-font mt-0 mr-1"><em>{{ exercise_basics["title"] }}</em></div>
            </div>

            <div class="buttons">
                <a class="button is-medium is-dark" id='submit_button'>Submit</a>

                {% if exercise_details["back_end"] != "not_code" and not exercise_details["allow_any_response"] and assignment_details["show_run_button"] %}
                    <a class="button is-medium is-primary is-outlined" onclick='run_code(true)' id='run_button'>Run</a>
                {% end %}

                {% if assignment_details["has_timer"] and not is_administrator and not is_instructor and not is_assistant %}
                    <a id="timer_button" class="button is-medium is-hidden is-warning" style="cursor: auto;"></a>
                {% end %}

                <span class="icon mb-2 ml-1">
                    {% if exercise_details["allow_any_response"] %}
                        <p class="is-primary has-tooltip-multiline has-tooltip-right" data-tooltip="After you have entered your response, click on 'Submit'." />
                    {% else %}
                        <p class="is-primary has-tooltip-multiline has-tooltip-right" data-tooltip="When you are ready to test your solution, click on 'Submit'. If you would like to see the output of your solution without submitting it, click on 'Run' (if it is available). If you highlight a section of code and hit the Tab button, it will indent all lines of code in the block. If you hit Shift-Tab, it will reduce the indentation." />
                    {% end %}

                    <i class="far fa-question-circle"></i>
                </span>
            </div>

            <div id="max_submissions_message"></div>

            {% if assignment_details["due_date"] and assignment_details["due_date_passed"] and assignment_details["view_answer_late"] and not has_passed %}
                <div class='notification is-warning'>
                    <p>Click <a style='color:#2166ac' href="/view_instructor_solution/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}">here</a> to view the instructor's solution.
                    </p>
                </div>
            {% end %}

            <p id="test_outputs"></p>

            <p id="result_message"></p>

            <p id="submissions"></p>

            {% if len(exercise_details["credit"]) > 0 %}
                <div class="front-row-container">
                    <p style="padding-right: 5px;"><em>Credit: </em></p>
                    <p><em>{{ exercise_details["credit"] }}</em></p>
                </div>
            {% end %}

            <div class="buttons">
                {% if is_administrator or is_instructor or is_assistant %}
                    <a class="button is-dark" href="/edit_exercise/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}">Edit exercise</a>
                {% end %}

                {% if prev_exercise %}
                    <a class="button is-outlined" href="/exercise/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ prev_exercise['id'] }}">Previous exercise</a>
                {% end %}

                {% if next_exercise %}
                    <a class="button is-outlined" href="/exercise/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ next_exercise['id'] }}">Next exercise</a>
                {% end %}
            </div>

            <div id="submit_exercise_modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h6 style="display:inline">Pair programming:</h6>
                    <label class="has-tooltip-multiline has-tooltip-right" data-tooltip="If using pair programming for this exercise, enter the name of your partner here.">
                        <i class="far fa-question-circle"></i>
                    </label><br />

                    <div id="submit_exercise_modal_message"></div>

                    <div id="partner_selection">
                        <p>Select your pair programming partner here. If you are working on the exercise without a partner, leave this field blank.</p>
                        {% if users %}
                            <input class="space_div input is-primary" list="users_list" id="partner_name" placeholder="Enter partner's name here...">
                            <datalist id="users_list">
                                {% for user_name in users %}
                                    <option value="{{ user_name }}"></option>
                                {% end %}
                            </datalist>
                        {% else %}
                            <p>There are no other registered students in this course, so your only option is to leave this field blank.</p>
                        {% end %}

                        <input type="hidden" id="partner_id" />
                    </div>

                    <p class="buttons">
                        <a id="modal_submit_button" class="modal-button button is-dark">Submit</a>
                        <a id="submit_cancel_button" class="modal-button button is-light">Cancel</a>
                    </p>
                </div>
            </div>

            <script>
                {% if use_virtual_assistant %}
                    let left_column = document.getElementById("left_column");
                    let right_column = document.getElementById("right_column");
                    right_column.style.height = `${left_column.offsetHeight}px`;

                    let virtual_assistant_interactions = JSON.parse("{{ virtual_assistant_interactions }}");
                    let max_questions_per_exercise = {{ virtual_assistant_max_per_exercise }};

                    let input_element = document.getElementById("virtual_assistant_input");
                    let output_element = document.getElementById("virtual_assistant_output");
                    let message_element = document.getElementById("virtual_assistant_message");
                    let button_element = document.getElementById("virtual_assistant_button");

                    let allowed_panel_element = document.getElementById("virtual_assistant_allowed_panel")
                    let allowed_element = document.getElementById("virtual_assistant_questions_allowed");
                    let allowed_prefix_element = document.getElementById("virtual_assistant_questions_allowed_prefix");
                    let allowed_suffix_element = document.getElementById("virtual_assistant_questions_allowed_suffix");

                    function askVirtualAssistant() {
                        let input = input_element.value;

                        if (input.trim().length == 0)
                            return;

                        
                        output_element.classList.remove("is-hidden");

                        let response_element = createVirtualAssistantResponse("Please wait...");
                        addVirtualAssistantEcho(input);

                        let data = {"question": input, "student_code": editor.getValue()};

                        $.ajax({
                            type: 'POST',
                            url: "/ask_virtual_assistant/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}",
                            data: data,
                            async: true,
                        }).done(function(result) {
                            let result_dict = JSON.parse(result);

                            if (result_dict.success) {
                                response_element.classList.add('has-text-info');

                                if (max_questions_per_exercise > 0) {
                                    allowed_element.innerHTML = allowed_element.innerHTML - 1;

                                    checkMaxVirtualAssistantQuestionsAsked();
                                }

                                data["response"] = result_dict["message"];
                                virtual_assistant_interactions.push(data);
                            } else {
                                response_element.classList.add('has-text-danger');
                            }

                            response_element.innerHTML = `<em>VA</em>: ${result_dict.message}`;
                        })
                        .fail(function(result) {
                            console.log(result);
                            response_element.classList.add('has-text-danger');
                            response_element.innerHTML = result;
                        });
                    }

                    function closeVirtualAssistant() {
                        save_presubmission();
                        window.location.href = `${window.location.pathname}?hide_va=true`;
                    }

                    function addVirtualAssistantEcho(input) {
                        var echo_element = document.createElement('div');
                        echo_element.classList.add('has-text-dark', 'has-background-light', 'm-2', 'pl-2', 'pr-2', 'pt-1', 'pb-1');
                        echo_element.innerHTML += `<em>You asked</em>: ${input}`;

                        output_element.insertBefore(echo_element, output_element.firstChild);
                    }

                    function createVirtualAssistantResponse(message) {
                        var response_element = document.createElement('div');
                        response_element.classList.add('has-background-light', 'has-text-info', 'is-bordered', 'm-2', 'pl-2', 'pr-2', 'pt-1', 'pb-1');
                        response_element.innerHTML = `<em>VA</em>: ${message}`;

                        output_element.insertBefore(response_element, output_element.firstChild);

                        return response_element;
                    }

                    function checkMaxVirtualAssistantQuestionsAsked() {
                        if (allowed_element.innerHTML <= 0) {
                            message_element.classList.add("has-text-grey-lighter");
                            input_element.disabled = true;
                            button_element.disabled = true;
                        }

                        let question_text = allowed_element.innerHTML == 1 ? "question" : "questions"; 

                        if (virtual_assistant_interactions.length == 0) {
                            allowed_prefix_element.innerHTML = "Up to ";
                            allowed_suffix_element.innerHTML = `${question_text} allowed`;
                        }
                        else {
                            allowed_prefix_element.innerHTML = "";
                            allowed_suffix_element.innerHTML = `more ${question_text} allowed`;
                        }

                        allowed_panel_element.classList.remove("is-hidden");
                    }

                    if (max_questions_per_exercise > 0) {
                        allowed_element.innerHTML = Math.max(0, max_questions_per_exercise - virtual_assistant_interactions.length);

                        checkMaxVirtualAssistantQuestionsAsked();
                    }

                    if (virtual_assistant_interactions.length > 0) {
                        output_element.classList.remove("is-hidden");

                        for (let interaction of virtual_assistant_interactions) {
                            let response_element = createVirtualAssistantResponse(interaction.response);
                            response_element.classList.add('has-text-info');

                            addVirtualAssistantEcho(interaction.question);
                        }
                    }
                {% end %}

                ace.require("ace/ext/language_tools");

                var editor = ace.edit("user_code", {
                    theme: "ace/theme/{{ user_info['ace_theme'] }}",
                    autoScrollEditorIntoView: false,
                    minLines: 20,
                    fontSize: "12pt"
                });

                editor.setHighlightActiveLine(false);
                editor.setShowPrintMargin(false);
                editor.session.setOption('newLineMode', 'unix');

                {% if user_info['enable_vim'] %}
                   editor.setKeyboardHandler("ace/keyboard/vim");
                {% end %}

                {% if exercise_details["back_end"] == "not_code" %}
                    editor.session.setUseWrapMode(true);
                {% else %}
                    {% if user_info["use_auto_complete"] %}
                        editor.setOptions({
                            enableBasicAutocompletion: false,
                            enableSnippets: true,
                            enableLiveAutocompletion: true
                        });
                    {% end %}
                {% end %}

                editor.focus();
                editor.getSession().setMode("{{ code_completion_path }}");

                submitButton = document.getElementById("submit_button");

                if (submitButton != null) {
                    submitButton.onclick = function() {
                        {% if not assignment_details["due_date"] or not assignment_details["due_date_passed"] or assignment_details["allow_late"] %}
                            {% if exercise_details["enable_pair_programming"] %}
                                showSubmitModal();
                            {% else %}
                                submit();
                            {% end %}
                        {% else %}
                            alert("Sorry, the due date for this assignment has passed.");
                        {% end %}
                    }
                }

                {% if assignment_details["has_timer"] and not is_administrator and not is_instructor and not is_assistant %}
                    function updateTimeRemaining(timer_deadline) {
                        const now = new Date().getTime();
                        const remaining_time = timer_deadline - now;

                        const hours = Math.floor((remaining_time % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((remaining_time % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((remaining_time % (1000 * 60)) / 1000);

                        if (remaining_time >= 0) {
                            $("#timer_button")[0].innerHTML = `<strong>Time remaining: ${hours}h ${minutes}m ${seconds}s</strong>`;
                        }

                        return remaining_time;
                    }

                    function gotoAssignmentPage() {
                        window.location.href = `/assignment/{{ course_basics["id"]}}/{{ assignment_basics["id"] }}`;
                    }

                    if ("{{ timer_status }}" == "timer_in_progress") {
                        let timer_deadline = new Date("{{ timer_deadline }}");
                        timer_deadline.setMinutes(timer_deadline.getMinutes() - timer_deadline.getTimezoneOffset());

                        var has_shown_timer_warning = false;
                        let time_remaining = updateTimeRemaining(timer_deadline);

                        if (time_remaining <= 0) {
                            gotoAssignmentPage();
                        }
                        else {
                            const x = setInterval(function() {
                                const remaining_time = updateTimeRemaining(timer_deadline);

                                if (remaining_time < 120000 && !has_shown_timer_warning) {
                                    alert("Less than 2 minutes remaining.");
                                    has_shown_timer_warning = true;
                                }

                                if (remaining_time <= 0) {
                                    clearInterval(x);
                                    save_presubmission();
                                    gotoAssignmentPage();
                                }
                            }, 1000);

                            $("#timer_button").removeClass("is-hidden");
                        }
                    }
                    else {
                        gotoAssignmentPage();
                    }
                {% end %}

                const tests = {{ jsonify(tests) }};

                var submissions = {{ jsonify(submissions) }};
                var presubmission = {{ jsonify(presubmission) }};

                show_past_submissions();

                if (submissions.length == 0) {
                    showTestOutputs(null, false);

                    if (presubmission) {
                        editor.focus();
                        editor.setValue(presubmission, 1);
                    }
                }
                else {
                    var latest_submission = submissions[submissions.length - 1];

                    // Set editor value to presubmission if the presubmission is different than the latest submission code.
                    if (presubmission && presubmission != latest_submission.code) {
                        editor.focus();
                        editor.setValue(presubmission, 1);
                    }
                    else {
                        get_submission(latest_submission.id, false, true);
                    }
                }

                let codeChanged = false;
                window.wasUserChange = true;

                // editor.session.on('change', function(delta) {
                editor.on('change', function() {
                    if (window.wasUserChange){
                        codeChanged = true;
                        saved_div.innerHTML = `<span class="icon mt-0 ml-1">
                            <i class="far fa-save fa-2x" style="cursor: pointer;"  onclick="save_presubmission();editor.focus();"></i>
                        </span>`;
                    }
                });

                // Autosave if code has changed
                setInterval(function() {
                    if (codeChanged) {
                        save_presubmission();
                    }
                }, 10000);

                setInterval(function() {
                    reloadIfRestricted(true);
                }, 60000);
            </script>
        {% else %}
            <p>This exercise does not exist.</p>
        {% end %}
    {% else %}
        <p>This assignment does not exist.</p>
    {% end %}
{% else %}
    <p>This course does not exist.</p>
{% end %}