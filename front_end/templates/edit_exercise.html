<!-- <copyright_statement>-->
<!--   CodeBuddy: A programming assignment management system for short-form exercises-->
<!--   Copyright (C) 2023 Stephen Piccolo-->
<!--   This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more details. You should have received a copy of the GNU Affero General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.-->
<!-- </copyright_statement>-->

<div class="row-container is-hidden" id="edit_header">
    <h3>Edit exercise</h3>

    <p>
        <button class="button is-dark" onclick="save()">Save</button>

        <a class="button is-white" onclick="showOutput(false, true)">View output</a>

        <a class="button is-white" id="done_button1">Done</a>

        {% if prev_exercise %}
            <a class="button is-white" href="/edit_exercise/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ prev_exercise['id'] }}">Previous exercise</a>
        {% end %}
        {% if next_exercise %}
            <a class="button is-white" href="/edit_exercise/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ next_exercise['id'] }}">Next exercise</a>
        {% end %}
    </p>
</div>

<h3 id="create_header">Create exercise</h3>

<div class="notification is-danger is-hidden" id="result_message"></div>

{% if course_basics["exists"] %}
  {% if assignment_basics["exists"] %}
    <script>
        // https://www.w3docs.com/snippets/javascript/how-to-sort-javascript-object-by-key.html
        // https://fuzzytolerance.info/blog/2019/07/19/The-better-way-to-do-natural-sort-in-JavaScript/
        function sortObj(obj) {
            return Object.keys(obj).sort((a, b) => a.localeCompare(b, navigator.languages[0] || navigator.language, {numeric: true, ignorePunctuation: true})).reduce(function (result, key) {
                result[key] = obj[key];
                return result;
            }, {});
        }
    </script>

    <div class="shadow-box">
        <div class="row-container bottom-space">
            <div class="a-title-container">
                <p><strong>Title*:</strong></p>
                <p><input id="title" class="input is-grey is-fullwidth" placeholder="Please specify a descriptive title." autofocus></p>
            </div>
            <div class="a-visible">
                <p><strong>Visible to students: </strong>
                    <div class="select is-grey">
                        <select id="visible" class="edit-select">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                </p>
            </div>
        </div>

        <div class="front-row-container">
            <div class="a-visible">
                <p><strong>Back end: </strong>
                    <label class="is-primary has-tooltip-multiline has-tooltip-right" data-tooltip="Choose the back end that will be used to check the students' solution. In most cases, a back end is associated with a specific programming language. The not_code option enables students to submit a solution by entering text rather than coding.">
                        <i class="far fa-question-circle"></i>
                    </label>
                    <div class="select is-grey">
                        <select id="back_end" onchange="updateBackEndOptions(this.value, null)" class="edit-select">
                        </select>
                    </div>
                </p>
            </div>

            <div class="a-visible">
                <p><strong>Output type: </strong>
                    <div class="select is-grey">
                        <select id="output_type" class="edit-select">
                        </select>
                    </div>
                </p>
            </div>

            <div class="a-visible">
                <p><strong>Allow any response: </strong>
                    <div class="select is-grey">
                        <select id="allow_any_response" class="edit-select">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                </p>
            </div>
        </div>

        <div class="top-space">
            <p><strong>Instructions*: </strong><br />Please write instructions for this exercise. You may use <a href="https://www.markdownguide.org/basic-syntax/" target='_blank' rel='noopener noreferrer'>Markdown syntax</a> to format the text. If you would like, you can use the following shortcuts to customize the instructions.</p>
            
            <ul>
                <li>Add a link to the previous exercise by placing <code>[previous_exercise_link]</code> in the instructions. When students see the instructions, this text will be replaced with a link to the previous exercise.</li>
                <li>Place <code>[reflection_prompt]</code> in the instructions. Depending on the exercise settings, students might be asked to reflect on their own solution or to compare their solution against either the instructor's solution or a peer's solution.</li>
                <li>If you place <code>[copy_previous]</code> in the instructions, a button will appear that allows the student to copy their (last successful) solution from the previous exercise.</li>
                <li>You can add video(s) to the instructions. To add a YouTube video, specify <code>youtube:id</code>, replacing "id" with the unique identifier for a particular video. For example, for <a href="https://www.youtube.com/watch?v=PLOPygVcaVE" target="_blank">this video</a>, you would use "youtube:PLOPygVcaVE".</li>
            </ul>

            <p><textarea id="instructions" class="textarea" rows=10 placeholder="Please provide instructions for this assignment."></textarea></p>
        </div>

        <div class="row-container top-space">
            <div>
                <p><strong>Enable pair programming for this exercise: </strong>
                    <div class="select is-grey">
                        <select id="enable_pair_programming" class="edit-select">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                </p>
            </div>
        </div>

        <div class="row-container top-space">
            <div>
                <strong>Weight: </strong>

                <label class="is-primary has-tooltip-multiline has-tooltip-right" data-tooltip="By default, each exercise has a weight of 1.0. You can modify these weights so that some exercises are counted more (or less) toward the assignment score than other exercises.">
                    <i class="far fa-question-circle"></i>
                </label>

                <div style="margin-top:1em;">
                    <input class="input"
                           type="text"
                           id="weight"
                           style="width: 70px;"
                           value="1.0"
                           placeholder="Please enter a positive number."
                           oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1');" />
                </div>
            </div>
        </div>
    </div>

    <div class="shadow-box">
        <p><strong>Credit: </strong>
            <br />If anyone should be given credit for creating this exercise, please indicate that here. You may use <a href="https://www.markdownguide.org/basic-syntax/" target='_blank' rel='noopener noreferrer'>Markdown syntax</a> to format the text. Please provide a link to the data source(s) if you obtained the dataset from someone else.
        </p>

        <textarea class="textarea is-grey is-fullwidth monospace" placeholder="Please write the credit statement here." rows="2" id="credit"></textarea></p>

        <p><strong>Data file(s):</strong></p>

        <p>Optionally, you can upload data files that students will use on this exercise. You can upload more than one file, if needed. The maximum amount of data per exercise is 10 megabytes across all files. If a file name ends with <code>.hide</code>, that file's contents will be hidden from students; hidden files are only available for tests for which the test code and outputs are <em>not</em> shown. If the file name ends with <code>.csv</code>, it will be assumed that the file contains comma-separated values, and the data will be shown as a table. If the file name ends with <code>.tsv</code>, it will be assumed that the file contains tab-separated values, and the data will be shown as a table.</p>

        <div id="files_table" class="table-container"></div>

        <div class="file is-normal">
            <label class="file-label">
                <input class="file-input" type="file" id="upload_file_control" multiple>
                <span class="file-cta">
                    <span class="file-icon">
                        <i class="fas fa-upload"></i>
                    </span>
                    <span class="file-label">
                        Upload a file...
                    </span>
                </span>
            </label>
        </div>
    </div>

    <div class="shadow-box">
        <div>
            <p><strong>Solution*: </strong></p>
            <p>Please specify a solution for this exercise. If it requires programming, the solution will be executed, and the output of your solution will be used as the expected output. Please note: If your solution changes after students have already submitted answers, any students' answers that were previously marked as correct will remain as correct, but only your most recent solution will appear when students view past submissions. This may be confusing to students, so use caution when changing the solution; consider creating a new exercise instead.</p>
            <p id="solution_additional_instructions"></p>
            <textarea id="solution_code" id="solution_code" placeholder="Please provide a solution." rows="10"></textarea>
            <!-- https://stackoverflow.com/questions/50662513/ace-editor-how-to-move-changed-data-to-post-or-get -->
        </div>

        <div class="button is-light space-div" id="example_solution_button" onclick="toggleExample('solution')">
          Show example code
        </div>
    </div>

    <div class="shadow-box">
        <div>
            <p><strong>Verification logic:</strong></p>
            <p>In some cases, instructors wish to check certain aspects of a student's code before it is executed. For example, they may wish to verify that the student has not used certain functions, variable names, etc. If you wish to use this functionality, enter code in the box below. The code must be in the same programming language as the student's. The student's code will be saved in a file called "code" in the current working directory. Your code must read this file and then check the student's code. If a problem is found, print a message to standard output. Otherwise, print nothing to standard output.</p>
            <p id="verification_additional_instructions"></p>
                <textarea class="textarea is-fullwidth monospace" placeholder="Please provide verification code." rows="10" id="verification_code" id="verification_code"></textarea>
            </p>
        </div>

        <div class="button is-light space-div" id="example_verification_button" onclick="toggleExample('verification')">
          Show example code
        </div>
    </div>

    <div class="shadow-box">
        <p><strong>Tests:</strong></p>

        <p>You can write one or more tests to evaluate the students' code. In most cases, if you do not provide one, a simple default test will be generated for you. A test can be as simple as executing the student's code and verifying that their output matches that of the instructor's solution. Additionally, you can include code that is executed before and/or after the students' code. For example, you could use code that declares variables <em>before</em> the student's code is executed. Or if you have asked students to write function(s); you can use code that invokes their function(s) <em>after</em> the student's code has been executed. You might include multiple such tests to ensure their code works properly in multiple scenarios.</p>
        
        <p>For each test, you must indicate whether the test code will be visible to students, whether the expected output will be visible to students, and whether the output of students' code will be visible to them. To aid in debugging, we recommend that at least one test show the test code, expected output, and the students' output. However, hiding some or all of this information for at least one test can prevent cheating.</p>

        <p id="test_additional_instructions"></p>

        <div id="tests_table" class="table-container"></div>

        <div class="button is-light bottom-space mt-9" id="add_test_button">
            Add test
        </div>
    </div>

    <div class="shadow-box">
        <div>
            <p><strong>Starter code: </strong></p>
            <p>Starter code will be given to a student when they haven't made any submissions yet. They'll be able to add to this code in order to solve the exercise.</p>
            <p>
                <textarea class="textarea is-fullwidth monospace" placeholder="Please provide starter code." rows="10" id="starter_code" id="starter_code"></textarea>
            </p>
        </div>
    </div>

    <div class="shadow-box">
        <div class="space-div">
            <p><strong>Hint:</strong><br />You may specify a hint for this exercise. Use <a href="https://www.markdownguide.org/basic-syntax/" target='_blank' rel='noopener noreferrer'>Markdown syntax</a> to format the text.</p>
            <p><textarea class="textarea is-grey is-fullwidth monospace" placeholder="Please write in Markdown." rows="3" id="hint"></textarea></p>
        </div>

        <div class="bottom-space">
            <p><strong>Solution description:</strong><br />You may write a description of your solution. Use <a href="https://www.markdownguide.org/basic-syntax/" target='_blank' rel='noopener noreferrer'>Markdown syntax</a> to format the text.</p>
            <p><textarea class="textarea is-grey is-fullwidth monospace" placeholder="Please write in Markdown." rows="5" id="solution_description"></textarea></p>
        </div>

        <div class="row-container bottom-space">
            <div>
                <p><strong>Maximum # of submissions:</strong></p>
                <p>
                    <div class="select is-grey">
                        <select id="max_submissions" class="edit-select">
                        {% for i in [0, 1, 2, 3, 4, 5, 10, 20, 50, 100] %}
                            {% if i == 0 %}
                                <option value="0">Unlimited</option>
                            {% else %}
                                <option>{{ i }}</option>
                            {% end %}
                        {% end %}
                        </select>
                    </div>
                </p>
            </div>
        </div>

        <div class="row-container bottom-space">
            <div>
                <p>
                    <strong>What students can see after they pass the exercise:</strong>

                    <div class="select is-grey">
                        <select id="what_students_see_after_success" class="edit-select">
                            <option value="0">No solution from instructor or peers</option>
                            <option value="1">The instructor's solution - always</option>
                            <option value="2">Anonymized peers' solutions - always</option>
                            <option value="3">Both types of solutions - always</option>
                            <option value="4">The instructor's solution - only students randomly assigned to group "A"</option>
                            <option value="5">Anonymized peers' solutions - only students randomly assigned to group "A"</option>
                            <option value="6">The instructor's solution - only students randomly assigned to group "B"</option>
                            <option value="7">Anonymized peers' solutions - only students randomly assigned to group "B"</option>
                            <option value="8">Both types of solutions - only students randomly assigned to group "A"</option>
                            <option value="9">Both types of solutions - only students randomly assigned to group "B"</option>
                        </select>
                    </div>
                </p>
            </div>
        </div>
    </div>

    <p class="buttons">
        <button class="button is-dark" onclick="save()">Save</button>

        <span id="bottom_buttons" class="is-hidden">
            <a class="button is-white" id="done_button2">Done</a>

            {% if prev_exercise %}
                <a class="button is-white" href="/edit_exercise/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ prev_exercise['id'] }}">Previous exercise</a>
            {% end %}
            {% if next_exercise %}
                <a class="button is-white" href="/edit_exercise/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ next_exercise['id'] }}">Next exercise</a>
            {% end %}
        </span>
    </p>

    <div class="is-hidden" id="output">
    </div>

    <div id="add_test_modal" class="modal is-clipped">
        <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title is-size-5 has-text-centered has-text-weight-bold">Add test</p>
                    <button class="delete" aria-label="close" id="add_test_modal_close"></button>
                </header>

                <section class="modal-card-body">
                    <div class="has-text-weight-medium mb-2">Test title*:<br />
                      <input type="hidden" id="add_test_id" />
                      <textarea id="add_test_title" placeholder="Please specify a short, descriptive title." class="textarea is-fullwidth" rows="1" autofocus></textarea>
                    </div>

                    <div class="has-text-weight-medium mb-2">Instructions:<br />
                      <textarea id="add_test_instructions" placeholder="You may specify instructions about this test. Use Markdown syntax to format the instructions." class="textarea is-fullwidth" rows="4"></textarea>
                    </div>

                    <div class="has-text-weight-medium mb-2">Code that will be executed <em>before</em> the student's code:<br />
                      <textarea id="before_test_code" placeholder="Please specify any code that will be executed before the student's code." class="textarea is-fullwidth monospace"></textarea>
                    </div>

                    <div class="has-text-weight-medium mb-2">Code that will be executed <em>after</em> the student's code*:<br />
                      <textarea id="after_test_code" placeholder="Please specify any code that will be executed after the student's code." class="textarea is-fullwidth monospace"></textarea>
                    </div>

                    <div class="button is-light bottom-space" id="example_after_test_button" onclick="toggleExample('after_test')">
                        Show example code
                    </div>

                    <div class="has-text-weight-medium mb-2">Do you want students to see the test code?</div>
                    <div class="select is-primary">
                        <select id="can_see_test_code">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div class="has-text-weight-medium mb-2 mt-4">Do you want students to see the expected output?</div>
                    <div class="select is-primary">
                        <select id="can_see_expected_output">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div class="has-text-weight-medium mb-2 mt-4">Do you want students to see the output of their code?</div>
                    <div class="select is-primary">
                        <select id="can_see_code_output">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>

                    <div id="test_message" class="notification mt-4 mb-1"></div>
                    <input type="hidden" id="previous_test_title" />
                </section>

                <footer class="modal-card-foot">
                    <button class="button is-primary" id="add_test_modal_add">Add / Update</button>
                    <button class="button" id="add_test_modal_cancel">Cancel</button>
                </footer>
            </div>
        </div>
    </div>

    <div id="view_file_modal" class="modal is-clipped">
        <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title is-size-5 has-text-centered has-text-weight-bold" id="view_file_modal_header"></p>
                    <button class="delete" aria-label="close" id="view_file_modal_close"></button>
                </header>

                <section class="modal-card-body">
                    <textarea id="view_file_modal_text" class="textarea is-fullwidth"></textarea>
                </section>
            </div>
        </div>
    </div>

    <script>
        // Functions
        function showTests() {
            if (Object.keys(exercise_details_obj["tests"]).length == 0) {
                $("#tests_table").addClass("is-hidden");
                return;
            }

            var html = "<table class='table is-striped'>";
            html += "<thead><tr><th>Title</th><th>See test code</th><th>See expected output</th><th>See code output</th><th>Edit</th><th>Delete</th></thead>";
            html += "<tbody>";
            
            for (const test_title in sortObj(exercise_details_obj["tests"])) {
                html += "<tr>";
                html += `  <td>${test_title}</td>`;
                html += `  <td>${exercise_details_obj["tests"][test_title].can_see_test_code ? "Yes" : "No"}</td>`;
                html += `  <td>${exercise_details_obj["tests"][test_title].can_see_expected_output ? "Yes" : "No"}</td>`;
                html += `  <td>${exercise_details_obj["tests"][test_title].can_see_code_output ? "Yes" : "No"}</td>`;
                html += `  <td>
                               <a onclick="editTest('${test_title}')">
                                   <i class="fas fa-edit"></i>
                               </a>
                           </td>`;
                html += `  <td>
                               <a onclick="removeTest('${test_title}')">
                                   <i class="fas fa-trash-alt"></i>
                               </a>
                           </td>`;
                html += "</tr>";
            }

            html += "</tbody>";
            html += "</table>";

            $("#tests_table")[0].innerHTML = html;
            $("#tests_table").removeClass("is-hidden");
        }

        function showFiles() {
            if (Object.keys(exercise_details_obj["data_files"]).length == 0) {
                $("#files_table").addClass("is-hidden");
                return;
            }

            var html = "<table class='table is-striped'>";
            html += "<thead><tr><th>Name</th><th>Size (characters)</th><th>View</th><th>Delete</th></thead>";
            html += "<tbody>";

            for (const file_name in sortObj(exercise_details_obj["data_files"])) {
                html += "<tr>";
                html += `  <td>${file_name}</td>`;
                html += `  <td>${exercise_details_obj["data_files"][file_name].length}</td>`;
                html += `  <td>
                               <a onclick="viewFile('${file_name}')">
                                   <i class="fas fa-file-alt"></i>
                               </a>
                           </td>`;
                html += `  <td>
                               <a onclick="removeFile('${file_name}')">
                                   <i class="fas fa-trash-alt"></i>
                               </a>
                           </td>`;
                html += "</tr>";
            }

            html += "</tbody>";
            html += "</table>";

            $("#files_table")[0].innerHTML = html;
            $("#files_table").removeClass("is-hidden");
        }

        function showOutput(update, scroll) {
            if (update) {
                if (getValue("allow_any_response") == "No") {
                    var html = `<h3>Test output:</h3><div class='shadow-box'>`;

                    for (const test_title in sortObj(exercise_details_obj["tests"])) {
                        if (Object.keys(exercise_details_obj["tests"]).length > 1)
                            html += `<div class="space-div"><p><strong>${test_title}:</strong></p>`;

                        if (exercise_details_obj["tests"][test_title]["txt_output_formatted"] != "") {
                            html += `<pre><code>${exercise_details_obj["tests"][test_title]["txt_output_formatted"]}</code></pre>`;
                        }

                        if (exercise_details_obj["output_type"] == "jpg" && exercise_details_obj["tests"][test_title]["jpg_output"] != "") {
                            html += `<p><figure class='img'><img src='data:image/jpg;base64,${exercise_details_obj["tests"][test_title]["jpg_output"]}' width='95%' /></figure></p>`;
                        }

                        html += "</div>";
                    }

                    $("#output")[0].innerHTML = html + "</div>";
                }
            }

            if (scroll)
                $("#output")[0].scrollIntoView();
        }

        function updateBackEndOptions(back_end, output_type) {
            // Find dropdown and clear out existing options
            be_select = document.getElementById("back_end");
            be_select.options.length = 0;

            // Set the back end options
            const sorted_keys = Object.keys(back_ends_obj).sort();
            for (let back_end_option of sorted_keys) {
                var opt = document.createElement('option');
                opt.value = back_end_option;
                opt.innerHTML = back_end_option;

                if (back_end == back_end_option)
                    opt.selected = true;

                be_select.appendChild(opt);
            }

            ot_select = document.getElementById("output_type");
            ot_select.options.length = 0;

            // Set the output type
            for (let output_type_option of Object.keys(back_ends_obj[back_end]["output_types"])) {
                var opt = document.createElement('option');
                opt.value = output_type_option;
                opt.innerHTML = back_ends_obj[back_end]["output_types"][output_type_option];

                if (output_type == null) {
                    if (output_type_option == "txt") {
                        opt.selected = true;
                    }
                }
                else {
                    if (output_type_option == output_type) {
                        opt.selected = true;
                    }
                }

                ot_select.appendChild(opt);
            }

            // Update code completion settings for code editors
            solution_code_editor.getSession().setMode(back_ends_obj[back_end]["code_completion_path"]);
            starter_code_editor.getSession().setMode(back_ends_obj[back_end]["code_completion_path"]);
            verification_code_editor.getSession().setMode(back_ends_obj[back_end]["code_completion_path"]);

            // Load back_end specific instructions and examples
            document.getElementById("solution_additional_instructions").innerHTML = `<em>${back_ends_obj[back_end].solution_instructions}</em>`;
            document.getElementById("verification_additional_instructions").innerHTML = `<em>${back_ends_obj[back_end].verification_instructions}</em>`;
            document.getElementById("test_additional_instructions").innerHTML = `<em>${back_ends_obj[back_end].test_instructions}</em>`;

            examples_obj["solution"] = back_ends_obj[back_end]["solution_example"].trim();
            examples_obj["verification"] = back_ends_obj[back_end]["verification_example"].trim();
            examples_obj["after_test"] = back_ends_obj[back_end]["after_test_example"].trim();

            showHideExampleButton("solution");
            showHideExampleButton("verification");
            showHideExampleButton("after_test");
        }

        function showHideExampleButton(example_type) {
            if (examples_obj[example_type] == "")
                $(`#example_${example_type}_button`).addClass("is-hidden");
            else
                $(`#example_${example_type}_button`).removeClass("is-hidden");
        }

        function toggleExample(example_type) {
            eval(`editor = ${example_type}_code_editor;`);
            var toggleButton = document.getElementById(`example_${example_type}_button`);

            if (editor.getValue() == examples_obj[example_type]) {
                if (example_type in cache_obj) {
                    editor.setValue(cache_obj[example_type], -1);
                    toggleButton.classList.remove("is-primary");
                    toggleButton.classList.add("is-light");
                    toggleButton.innerHTML = "Show example code";
                }
            }
            else {
                cache_obj[example_type] = editor.getValue();
                editor.setValue(examples_obj[example_type], -1);
                toggleButton.classList.remove("is-light");
                toggleButton.classList.add("is-primary");
                toggleButton.innerHTML = "Go back to previous code";
            }
        }

        function showTestMessage(message, isError, isMonospace) {
            $("#test_message").removeClass("is-hidden");

            if (isError) {
                $("#test_message").removeClass("is-warning");
                $("#test_message").addClass("is-danger");
            }
            else {
                $("#test_message").removeClass("is-danger");
                $("#test_message").addClass("is-warning");
            }

            if (isMonospace)
                $("#test_message")[0].innerHTML = `<pre>${message}</pre>`;
            else
                $("#test_message")[0].innerHTML = message;

            $("#test_message")[0].scrollIntoView();
        }

        function editTest(test_title) {
            document.getElementById("add_test_id").value = exercise_details_obj["tests"][test_title].test_id;
            document.getElementById("add_test_title").value = test_title;
            document.getElementById("add_test_instructions").value = exercise_details_obj["tests"][test_title].instructions;

            before_test_code_editor.setValue(exercise_details_obj["tests"][test_title].before_code, -1);
            after_test_code_editor.setValue(exercise_details_obj["tests"][test_title].after_code, -1);

            document.getElementById("can_see_test_code").value = exercise_details_obj["tests"][test_title].can_see_test_code ? "Yes" : "No";
            document.getElementById("can_see_expected_output").value = exercise_details_obj["tests"][test_title].can_see_expected_output ? "Yes" : "No";
            document.getElementById("can_see_code_output").value = exercise_details_obj["tests"][test_title].can_see_code_output ? "Yes" : "No";

            $("#test_message")[0].innerHTML = "";
            $("#test_message").addClass("is-hidden");

            document.getElementById("previous_test_title").value = test_title;

            $("#add_test_modal").addClass("is-active");
            $("#add_test_title").focus();
        }

        function removeTest(test_title) {
            delete exercise_details_obj["tests"][test_title];
            showTests();
        }

        function viewFile(file_name) {
            $("#view_file_modal_header")[0].innerHTML = file_name;
            view_file_editor.setValue(exercise_details_obj["data_files"][file_name], -1);
            $("#view_file_modal").addClass("is-active");
        }

        function removeFile(file_name) {
            delete exercise_details_obj["data_files"][file_name];
            showFiles();
        }

        function getEditor(textAreaID, minLines, maxLines) {
            var editor = ace.edit(textAreaID, {
                theme: "ace/theme/{{ user_info['ace_theme'] }}",
                minLines: minLines,
                maxLines: maxLines,
                fontSize: "12pt"
            });

            editor.setHighlightActiveLine(false);
            editor.setShowPrintMargin(false);
            editor.session.setOption('newLineMode', 'unix');
            return(editor);
        }

        function getValue(id) {
            return $(`#${id}`)[0].value;
        }

        function setValue(id, value) {
            $(`#${id}`)[0].value = value;
        }

        function showResultMessage(messageHTML, messageType) {
            $("#result_message").removeClass("is-primary");
            $("#result_message").removeClass("is-warning");
            $("#result_message").removeClass("is-danger");

            $("#result_message").addClass(`is-${messageType}`);

            $("#result_message").removeClass("is-hidden");
            $("#result_message")[0].innerHTML = messageHTML;
            window.scrollTo(0, 0);
        }

        function showTopBottomButtons(exists) {
            if (exists) {
                $("#edit_header").removeClass("is-hidden");
                $("#create_header").addClass("is-hidden");
                $("#bottom_buttons").removeClass("is-hidden");
                $("#output").removeClass("is-hidden");
            }
            else {
                $("#edit_header").addClass("is-hidden");
                $("#create_header").removeClass("is-hidden");
                $("#bottom_buttons").addClass("is-hidden");
                $("#output").addClass("is-hidden");
            }
        }

        function load() {
            showTopBottomButtons(exercise_basics_obj["exists"]);
            updateBackEndOptions(exercise_details_obj["back_end"], exercise_details_obj["output_type"]);
            setValue("title", exercise_basics_obj["title"]);

            for (let id of ["back_end", "output_type", "instructions", "credit", "hint", "solution_description", "max_submissions", "what_students_see_after_success"])
                setValue(id, exercise_details_obj[id]);

            for (let id of ["allow_any_response", "enable_pair_programming"])
                setValue(id, exercise_details_obj[id] ? "Yes" : "No");

            if (String(exercise_details_obj["weight"]) == String(parseInt(exercise_details_obj["weight"])))
                setValue("weight", `${exercise_details_obj["weight"]}.0`);
            else
                setValue("weight", exercise_details_obj["weight"]);

            setValue("visible", exercise_basics_obj["visible"] ? "Yes" : "No");

            solution_code_editor.setValue(exercise_details_obj["solution_code"], -1);
            verification_code_editor.setValue(exercise_details_obj["verification_code"], -1);
            starter_code_editor.setValue(exercise_details_obj["starter_code"], -1);

            showTests();
            showFiles();
            showOutput(true, false);
        }

        function save() {
            const title = getValue("title").trim();
            const instructions = getValue("instructions");
            const allow_any_response = getValue("allow_any_response") == "Yes";
            const solution_code = solution_code_editor.getValue();
            const weight = getValue("weight");

            // Check submission details
            if (title == "")
                return(showResultMessage("Please provide a title.", "danger"));
            if (title.length > 80)
                return(showResultMessage("The title cannot exceed 80 characters in length.", "danger"));
            if (instructions == "")
                return(showResultMessage("Please provide instructions.", "danger"));
            if (!allow_any_response && solution_code == "")
                return(showResultMessage("Except when any response is allowed, you must provide a solution.", "danger"));
            if(isNaN(weight))
                return(showResultMessage("The specified weight is not a number.", "danger"));

            // Make sure total file size is not too large across all files.
            var total_file_size = 0;
            for (let file_name of Object.keys(exercise_details_obj["data_files"]))
                total_file_size += exercise_details_obj["data_files"][file_name].length;

            let file_size_limit = 10 * 1000 * 1000;
            if (total_file_size > file_size_limit)
                return(showResultMessage(`The total file size [${total_file_size}] exceeds the 10,000,000 character limit.`, "danger"));

                if (Object.keys(exercise_details_obj["tests"]).length == 0 && !allow_any_response) {
                // If no tests were created, create a default one.
                exercise_details_obj["tests"] = {"Default test": {
                    "test_id": -1,
                    "before_code": "",
                    "after_code": "",
                    "instructions": "",
                    "can_see_test_code": 1,
                    "can_see_expected_output": 1,
                    "can_see_code_output": 1,
                    "txt_output": "",
                    "jpg_output": ""
                }}
            }

            var submission_obj = {
                "title": title,
                "visible": getValue("visible") == "Yes",
                "back_end": getValue("back_end"),
                "output_type": getValue("output_type"),
                "allow_any_response": allow_any_response,
                "instructions": instructions,
                "enable_pair_programming": getValue("enable_pair_programming") == "Yes",
                "weight": weight,
                "credit": getValue("credit"),
                "solution_code": solution_code,
                "verification_code": verification_code_editor.getValue(),
                "starter_code": starter_code_editor.getValue(),
                "hint": getValue("hint"),
                "solution_description": getValue("solution_description"),
                "what_students_see_after_success": getValue("what_students_see_after_success"),
                "max_submissions": getValue("max_submissions"),
                "data_files": exercise_details_obj["data_files"],
                "tests": exercise_details_obj["tests"]
            }

            showResultMessage("<b>Please wait...</b>", "warning");

            $.ajax({
                type: 'POST',
                url: "/edit_exercise/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/" + exercise_basics_obj['id'],
                data: JSON.stringify(submission_obj),
                async: true})
                .done(function(data) {
                    var json_data = JSON.parse(data);

                    if (json_data["message"] == "") {
                        exercise_basics_obj["id"] = json_data["exercise_id"];
                        exercise_details_obj = json_data["exercise_details"];

                        showTopBottomButtons(true);
                        showTests();
                        showOutput(true, false);
                        showResultMessage("<b>The exercise was saved successfully.</b>", "primary");
                    }
                    else {
                        showTopBottomButtons(true | exercise_basics_obj["exists"]);
                        showResultMessage(`<p>An error occurred.</p><pre>${json_data["message"]}</pre>`, "danger");
                    }
                })
                .fail(function(data) {
                    showResultMessage("<p>An error occurred when connecting to the server. It may be down.</p>", "danger");
                });
        }

        $("#done_button1").click(function() {
            location.href = `/exercise/{{ course_basics["id"] }}/{{ assignment_basics["id"] }}/${exercise_basics_obj["id"]}`;
        });

        $("#done_button2").click(function() {
            location.href = `/exercise/{{ course_basics["id"] }}/{{ assignment_basics["id"] }}/${exercise_basics_obj["id"]}`;
        });

        $("#add_test_modal_add").click(function() {
            var test_id = document.getElementById("add_test_id").value;
            if (test_id == "")
                test_id = -1;

            var test_title = document.getElementById("add_test_title").value;
            var test_instructions = document.getElementById("add_test_instructions").value;
            var before_test_code = before_test_code_editor.getValue();
            var after_test_code = after_test_code_editor.getValue();

            var can_see_test_code = document.getElementById("can_see_test_code").value == "Yes";
            var can_see_expected_output = document.getElementById("can_see_expected_output").value == "Yes";
            var can_see_code_output = document.getElementById("can_see_code_output").value == "Yes";

            // Make sure title is valid
            if (test_title.trim().length > 30)
                return showTestMessage("The maximum title length is 30 characters.", true, false);
            if (test_title.trim() == "")
                return showTestMessage("Please specify a title.", true, false);
            for (let unallowed_char of ["'", "\"", "\\", "/", ">", "<", "|", ":", ";", "&", "?", "*"])
                if (test_title.includes(unallowed_char))
                    return showTestMessage(`The title cannot include the following character: ${unallowed_char}`, true, false);

            // Make sure other inputs are valid
            //if (!can_see_test_code && test_instructions.trim() == "")
            //    return showTestMessage("Please provide instructions when the test code is hidden.", true, false);

            let previous_test_title = document.getElementById("previous_test_title").value;

            if (test_title != previous_test_title) {
                if (previous_test_title != "" && previous_test_title in exercise_details_obj["tests"])
                    delete exercise_details_obj["tests"][previous_test_title];

                if (test_title in exercise_details_obj["tests"])
                    return showTestMessage("A test with that title has already been created. Please choose a different title.", true, false);
            }

            exercise_details_obj["tests"][test_title] = {"instructions": test_instructions, "can_see_test_code": can_see_test_code, "can_see_expected_output": can_see_expected_output, "can_see_code_output": can_see_code_output, "before_code": before_test_code, "after_code": after_test_code, "txt_output": "", "jpg_output": "", "test_id": test_id};
            showTests();

            $("#add_test_modal").removeClass("is-active");
        });

        $("#add_test_modal_cancel").click(function() {
            $("#add_test_modal").removeClass("is-active");
        });

        $("#add_test_modal_close").click(function() {
            $("#add_test_modal").removeClass("is-active");
        });

        $("#add_test_button").click(function() {
            document.getElementById("add_test_id").value = "";
            document.getElementById("add_test_title").value = "";
            document.getElementById("add_test_instructions").value = "";
            before_test_code_editor.setValue("", -1);
            after_test_code_editor.setValue("", -1);
            document.getElementById("can_see_test_code").value = "Yes";
            document.getElementById("can_see_expected_output").value = "Yes";
            document.getElementById("can_see_code_output").value = "Yes";

            $("#test_message")[0].innerHTML = "";
            $("#test_message").addClass("is-hidden");

            document.getElementById("previous_test_title").value = "";

            $("#add_test_modal").addClass("is-active");
            $("#add_test_title").focus();
        });

        $("#view_file_modal_close").click(function() {
            $("#view_file_modal").removeClass("is-active");
        });

        $("#upload_file_control").change(function() {
            (async () => {
                for (var i = 0; i < $("#upload_file_control")[0].files.length; i++) {
                    const fileName = $("#upload_file_control")[0].files[i]["name"];
                    const fileText = await $("#upload_file_control")[0].files[i].text();

                    //exercise_details_obj["data_files"][fileName] = {"contents": fileText, "size": $("#upload_file_control")[0].files[i]["size"]};
                    if (Array.isArray(exercise_details_obj["data_files"])) {
                        exercise_details_obj["data_files"] = {}
                    }
                    exercise_details_obj["data_files"][fileName] = fileText;
                }

                showFiles();
            })();
        });

        // Code to run on page load
        var solution_code_editor = getEditor("solution_code", 10, 25);
        var starter_code_editor = getEditor("starter_code", 10, 15);
        var verification_code_editor = getEditor("verification_code", 10, 15);
        var before_test_code_editor = getEditor("before_test_code", 5, 15);
        var after_test_code_editor = getEditor("after_test_code", 5, 15);
        var view_file_editor = getEditor("view_file_modal_text", 15, 15);
        ace.require("ace/ext/language_tools");

        var exercise_basics_obj = JSON.parse("{{ exercise_basics_json }}");
        var exercise_details_obj = JSON.parse("{{ exercise_details_json }}");
        var back_ends_obj = JSON.parse("{{ back_ends_json }}");
        var examples_obj = {};
        var cache_obj = {};

        load();
    </script>

    {% else %}
        This assignment has not been created yet.
    {% end %}
{% else %}
    This course has not been created yet.
{% end %}